name: GitHubActionsBuilds

on:
  schedule:
    - cron: '0 17 * * 5' # Runs every Friday at 5pm UTC
  workflow_dispatch: # Allows manual trigger

jobs:
  generate_version_number:
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ github.ref == 'refs/heads/master' && steps.buildnumber.outputs.build_number || 1 }}
    steps:
    - name: Generate build number
      if: github.ref == 'refs/heads/master'
      id: buildnumber
      uses: einaregilsson/build-number@v3
      with:
        token: ${{secrets.github_token}}

  build_linux:
    needs: generate_version_number
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    - name: dotnet restore
      run: dotnet restore DeveLanCacheUI_Backend.sln
    - name: dotnet build
      run: dotnet run DeveLanCacheUI_Backend.sln -c Release --no-restore
      env:
        STEAMTOKEN: ${{ secrets.STEAMTOKEN }}
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: 1.0.${{needs.generate_version_number.outputs.build_number}}
        files: |
          ./DeveLanCacheUI_SteamDepotFinder/bin/Release/net7.0/app-depot-output-cleaned.csv